on:
  push:
    branches: [main]
concurrency:
  group: ${{ github.workflow }}
env:
  TERM: xterm-256color
  FORCE_COLOR: 1
  NODE_AUTH_TOKEN: ${{secrets.NPM_TOKEN}}
jobs:
  main:
    runs-on: ubuntu-latest
    steps:
      - name: checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10
      - name: setup node
        uses: actions/setup-node@v4
        with:
          node-version: lts/*
          registry-url: https://registry.npmjs.org
      - name: install
        run: pnpm install --frozen-lockfile
      - name: build
        run: pnpm build
      - name: test
        run: pnpm test
      - name: publish
        run: |
          set -e
          NAME=$(pnpm pkg get name | jq -r)
          VERSION=$(pnpm pkg get version | jq -r)
          if pnpm info "${NAME}@${VERSION}" &>/dev/null; then
            echo "Not publishing package ${NAME}@${VERSION} because it already exists"
          else
            pnpm publish --dry-run
          fi
